var colors={intro:"#8bc34a",scores:"#ff754c",game:["#4c7fff","#4c68ff","#4c4cff","#4c7fff","#5858db","#6b6b98"],lose:"#ff4c4c",apple1:"#fff",apple2:"#fff",mine:"#000000"};
var cols=9,rows=16,game=function(){void 0,resetItemsProbas();var e=$("#game canvas")[0].getContext("2d"),n=function(){cols/rows<window.innerWidth/window.innerHeight?(e.canvas.height=window.innerHeight,e.canvas.width=e.canvas.height/rows*cols):(e.canvas.width=window.innerWidth,e.canvas.height=e.canvas.width/cols*rows)};n(),$(window).resize(function(e){e.target===window&&(n(),d())}),e.imageSmoothingEnabled=!1,e.mozImageSmoothingEnabled=!1,e.oImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1;var a="straight";$(window).keydown(function(e){switch(e.which){case 37:a="left";break;case 38:a="straight";break;case 39:a="right"}});var t,o;$("#game canvas").on("touchstart",function(e){e.preventDefault(),t=e.originalEvent.targetTouches[0].pageX,o=setInterval(function(){r()},10)}),$(window).on("touchend",function(){evt.preventDefault(),clearInterval(o)}),$(window).on("touchmove",function(e){e.preventDefault(),t=e.originalEvent.targetTouches[0].pageX}),$("#game canvas").on("mousedown",function(e){e.preventDefault(),t=e.clientX,o=setInterval(function(){r()},10)}),$(window).on("mouseup",function(e){e.preventDefault(),clearInterval(o)}),$(window).on("mousemove",function(e){e.preventDefault(),t=e.clientX});var r=function(){var n;n=t<$("#game canvas").offset().left?1:t>$("#game canvas").offset().left+e.canvas.width?cols:Math.ceil((t-$("#game canvas").offset().left)/(e.canvas.width/cols)),a=n<l.position[0]?"left":n>l.position[0]?"right":"straight"},i=0,c=0,s=new Particles,l=new Snake,g=new Items,d=function(){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.canvas.width=e.canvas.width,s.draw(e),l.draw(e),g.draw(e)};d();var h=setInterval(function(){d()},20),v=setInterval(function(){s.next()},20),w=setInterval(function(){i++,l.next(a),a="straight",g.next(),c=g.check(l,c),50===i&&(mineProbaAppear=.1),100===i&&($("body").animate({backgroundColor:colors.game[1]}),mineProbaAppear=.15),150===i&&($("body").animate({backgroundColor:colors.game[2]}),mineProbaAppear=.25),250===i&&($("body").animate({backgroundColor:colors.game[3]}),resetItemsProbas()),300===i&&($("body").animate({backgroundColor:colors.game[4]}),mineProbaAppear=.35),400===i&&($("body").animate({backgroundColor:colors.game[5]}),mineProbaAppear=.4,appleProbaAppear=.25),c+=l.getLength(),$("#score").html(c),l.getLength()<2&&u()},130),u=function(){function e(e,n){return n-e}if(clearInterval(h),clearInterval(w),clearInterval(v),$(window).unbind(),"undefined"!=typeof Storage){var n=localStorage.getItem("scores");n=n?JSON.parse(n):[],(n.length<5||c>n[n.length-1])&&(n.push(c),n.sort(e),6===n.length&&n.pop()),localStorage.setItem("scores",JSON.stringify(n))}updateScores(),$("body").animate({backgroundColor:colors.lose},function(){$("#lose").fadeIn(),lose()})}};
var intro=function(){void 0;var t=$("#intro canvas"),i=t[0],o=i.getContext("2d");i.width=500,i.height=250,o.strokeStyle="#000",o.lineWidth=40,o.lineCap="square";var n={position:[3,3,3,3,3,3,3,3,3,3],nextPosition:function(){this.position.shift();var t=this.position[this.position.length-1],i=Math.random();1/3>i&&t>1&&t--,i>2/3&&5>t&&t++,this.position.push(t)}},e=setInterval(function(){o.clearRect(0,0,i.width,i.height),o.canvas.width=o.canvas.width,o.strokeStyle="#000",o.lineWidth=40,o.lineCap="square",n.nextPosition(),o.beginPath(),o.moveTo(25,-25+50*n.position[0]);for(var t=1;t<=n.position.length-1;t++)n.position[t]!==n.position[t-1]&&o.lineTo(25+50*(t-1),-25+50*n.position[t]),o.lineTo(25+50*t,-25+50*n.position[t]);o.stroke();var e={x:25+50*(n.position.length-1),y:-25+50*n.position[n.position.length-1],r:5};o.clearRect(e.x-e.r,e.y-e.r,2*e.r,2*e.r)},100);$("#intro div.buttons button:first").click(function(){blinkEffect(this),playSoundGood(),o.clearRect(0,0,i.width,i.height),$("#intro div.buttons button").unbind(),clearInterval(e),introToGame()}),$("#intro div.buttons button:last").click(function(){blinkEffect(this),playSoundGood(),o.clearRect(0,0,i.width,i.height),$("#intro div.buttons button").unbind(),clearInterval(e),introToScores()}),$(window).keydown(function(t){switch(t.which){case 37:$("#intro div.buttons button:first").click();break;case 39:$("#intro div.buttons button:last").click()}})};
var maxNbApples=10,maxNbMines=100,appleProbaAppear,mineProbaAppear,resetItemsProbas=function(){appleProbaAppear=.5,mineProbaAppear=.05};resetItemsProbas();var Items=function(){this.apples=[],this.mines=[],this.checkApple=function(s){for(var e=0;e<this.apples.length;e++)if(this.apples[e].y===rows&&this.apples[e].x===s)return!0;return!1},this.next=function(){for(var s=0;s<this.apples.length;s++)this.apples[s].y--;for(var s=0;s<this.apples.length;s++)this.apples[s].y<0&&this.apples.splice(s,1);for(var s=0;s<this.mines.length;s++)this.mines[s].y--;for(var s=0;s<this.mines.length;s++)this.mines[s].y<0&&this.mines.splice(s,1);if(this.apples.length<maxNbApples&&Math.random()<appleProbaAppear){var e={x:Math.ceil(Math.random()*cols),y:rows};e.color=Math.random()>.5?colors.apple1:colors.apple2,this.apples.push(e)}if(this.mines.length<maxNbMines)for(var s=1;cols>=s;s++)if(!this.checkApple(s)&&Math.random()<mineProbaAppear){var i={x:s,y:rows};this.mines.push(i)}},this.draw=function(s){for(var e=s.canvas.width,i=s.canvas.height,t=e/cols,a=0;a<this.apples.length;a++)s.fillStyle=this.apples[a].color,s.fillRect((this.apples[a].x-1)*t+.2*t,i-this.apples[a].y*t+.3*t,.6*t,.4*t),s.fillRect((this.apples[a].x-1)*t+.3*t,i-this.apples[a].y*t+.2*t,.4*t,.6*t);for(var a=0;a<this.mines.length;a++)s.fillStyle=colors.mine,s.fillRect((this.mines[a].x-1)*t,i-this.mines[a].y*t,t,t)},this.check=function(s,e){for(var i=s.position[0],t=0;t<this.apples.length;)this.apples[t].y!==maxSnakeLength&&this.apples[t].y!==maxSnakeLength-1||this.apples[t].x!==i?t++:(s.eat(),this.apples.splice(t,1),e+=50);for(t=0;t<this.mines.length;)this.mines[t].y!==maxSnakeLength&&this.mines[t].y!==maxSnakeLength-1||this.mines[t].x!==i?t++:(s.hit(),this.mines.splice(t,1));return e}};
var lose=function(){void 0,$("#lose div.buttons button:first").click(function(){blinkEffect(this),playSoundGood(),$("#lose div.buttons button").unbind(),$("#lose").fadeOut(function(){gameToIntro()})}),$("#lose div.buttons button:nth-child(2)").click(function(){blinkEffect(this),playSoundGood(),$("#lose div.buttons button").unbind(),$("#lose").fadeOut(function(){$("body").animate({backgroundColor:colors.game[0]},function(){game()})})}),$("#lose div.buttons button:last").click(function(){blinkEffect(this),playSoundGood(),$("#lose div.buttons button").unbind(),$("#lose").fadeOut(function(){gameToScore()})}),$(window).keydown(function(o){switch(o.which){case 37:$("#lose div.buttons button:first").click();break;case 38:case 40:$("#lose div.buttons button:nth-child(2)").click();break;case 39:$("#lose div.buttons button:last").click()}})};
$(document).ready(function(){FastClick.attach(document.body),$("#game").hide(),$("#lose").hide(),$("#scores").hide(),updateScores(),intro()});var introToGame=function(){$("#intro").fadeOut(function(){$("body").animate({backgroundColor:colors.game[0]}),$("#game").fadeIn(function(){game()})})},introToScores=function(){$("#intro").fadeOut(function(){$("body").animate({backgroundColor:colors.scores}),$("#scores").fadeIn(function(){scores()})})},scoresToIntro=function(){$("#scores").fadeOut(function(){$("body").animate({backgroundColor:colors.intro}),$("#intro").fadeIn(function(){intro()})})},gameToIntro=function(){$("#game").fadeOut(function(){$("body").animate({backgroundColor:colors.intro}),$("#intro").fadeIn(function(){intro()})})},gameToScore=function(){$("#game").fadeOut(function(){$("body").animate({backgroundColor:colors.scores}),$("#scores").fadeIn(function(){scores()})})},blinkEffect=function(o){$(o).addClass("hover"),setTimeout(function(){$(o).removeClass("hover")},100)};
var maxNbParticles=10,particleProbaAppear=.15,particleWidthPercentage=.05,particleHeightPercentage=.15,Particles=function(){this.particles=[],this.next=function(){if(this.particles.length<maxNbParticles&&Math.random()<particleProbaAppear){var t={x:Math.random(),y:0};this.particles.push(t)}for(var e=0;e<this.particles.length;e++)this.particles[e].y+=.03,this.particles[e].y>1+particleHeightPercentage&&this.particles.splice(e,1)},this.draw=function(t){for(var e=t.canvas.width,i=t.canvas.height,a=e*particleWidthPercentage,r=i*particleHeightPercentage,c=0;c<this.particles.length;c++)t.fillStyle="rgba(255,255,255,0.2)",t.fillRect(this.particles[c].x*e,this.particles[c].y*i-r,a,r)}};
var scores=function(){void 0,$("#scores button").click(function(){blinkEffect(this),playSoundGood(),$("#scores button").unbind(),scoresToIntro()}),$(window).keydown(function(o){switch(o.which){case 37:$("#scores button").click()}})},updateScores=function(){if("undefined"!=typeof Storage){var o=localStorage.getItem("scores");o=o?JSON.parse(o):[];for(var t=0;t<o.length;t++)$("#scores table tbody tr:nth-child("+(t+1)+") td:nth-child(2)").html(o[t])}};
var initialSnakeLength=3,maxSnakeLength=8,snakeWidthPercentage=.8,snakeEyeWidthPercentage=.25,snakeEyeDistPercentage=.5,Snake=function(){this.position=[];for(var t=0;initialSnakeLength>t;t++)this.position.push(Math.ceil(cols/2));this.getLength=function(){return this.position.length},this.eat=function(){playSoundGood(),this.getLength()<maxSnakeLength&&this.position.push(this.position[this.getLength()-1])},this.hit=function(){playSoundBad(),this.position.pop()},this.next=function(t){if("left"===t){this.position.pop();var i=this.position[0];i>1&&i--,this.position.unshift(i)}else if("right"===t){this.position.pop();var i=this.position[0];cols>i&&i++,this.position.unshift(i)}else"straight"===t&&(this.position.pop(),this.position.unshift(this.position[0]))},this.draw=function(t){var i=t.canvas.width,n=t.canvas.height,e=i/cols,s=e,o=e*snakeWidthPercentage;t.lineCap="square",t.strokeStyle="#000",t.lineWidth=o,t.beginPath(),t.moveTo(this.position[0]*e-e/2,n-s*maxSnakeLength+s/2);for(var h=1;h<this.getLength();h++)this.position[h]!==this.position[h-1]&&t.lineTo(this.position[h-1]*e-e/2,n-s*maxSnakeLength+s/2+s*h),t.lineTo(this.position[h]*e-e/2,n-s*maxSnakeLength+s/2+s*h);t.stroke();var a=this.position[0]*e-e/2,p=n-s*maxSnakeLength+s/2,g=o/2*snakeEyeWidthPercentage,r=o*snakeEyeDistPercentage/2;t.clearRect(a-g-r,p-g,2*g,2*g),t.clearRect(a-g+r,p-g,2*g,2*g)}};
var soundOn=!0,soundGood=new Howl({urls:["sound/good.mp3"]}),soundBad=new Howl({urls:["sound/bad.mp3"]}),playSoundGood=function(){soundOn&&soundGood.play()},playSoundBad=function(){soundOn&&soundBad.play()};$("#sound button").click(function(){soundOn=!soundOn;var n=$("#sound button img")[0];n.src=soundOn?"img/sound_on.gif":"img/sound_off.gif"});